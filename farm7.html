<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini Farm — مزرعتي البسيطة</title>
<style>
  :root{
    --bg:#f0f6ef;
    --panel:#ffffff;
    --accent:#4caf50;
    --tile:#d9ead3;
    --soil:#b07a4b;
    --ready:#ffd54f;
    font-family: "Segoe UI", Tahoma, Arial, sans-serif;
  }
  html,body{height:100%; margin:0; background:var(--bg); color:#333}
  .wrap{max-width:1100px;margin:18px auto;padding:12px;display:flex;gap:16px;align-items:flex-start}
  .left{flex:1; background:var(--panel); padding:12px;border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.06); position:relative;}
  .right{width:300px;background:var(--panel); padding:12px;border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.06)}
  h1{margin:0 0 8px;font-size:20px}
  .row {display:flex;gap:8px;margin-bottom:8px;align-items:center}
  .status {display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:#f8fff8;padding:8px 10px;border-radius:8px;font-weight:600;color:#144d14;display:flex;align-items:center;gap:8px}
  .grid{display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; margin-top:12px}
  .tile{background:var(--tile); height:96px;border-radius:8px;display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer; user-select:none; border:2px solid rgba(0,0,0,0.03)}
  .tile .info{position:absolute; left:6px; top:6px; font-size:12px; background:rgba(255,255,255,0.75); padding:2px 6px;border-radius:4px}
  .soil{width:80%;height:60%; background:var(--soil); border-radius:6px; display:flex;align-items:center;justify-content:center; font-size:22px; color:white}
  .seed{font-size:28px}
  .progress{position:absolute; right:6px; bottom:6px; font-size:12px; background:rgba(255,255,255,0.85); padding:2px 6px;border-radius:4px}
  .controls{display:flex; gap:8px; margin-top:12px; align-items:center}
  select, button, input{padding:6px 8px;border-radius:6px;border:1px solid rgba(0,0,0,0.08); background:white}
  button.primary{background:var(--accent); color:white; border:none}
  .small{font-size:13px;color:#666}
  .log{height:200px; overflow:auto; padding:8px; border-radius:8px; background:#fff; border:1px dashed rgba(0,0,0,0.04); margin-top:12px}
  .tile.ready{box-shadow:0 0 0 4px rgba(255,213,79,0.12)}
  .center{display:flex;align-items:center;justify-content:center}
  .footer{font-size:12px;color:#666;margin-top:10px}
  .modal{position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center}
  .modal-content{background:white; padding:12px; border-radius:10px; width:80%; max-width:400px; max-height:80%; overflow:auto}
  @media(max-width:880px){.wrap{flex-direction:column}.right{width:100%}}
</style>
</head>
<body>
<div class="wrap">
  <div class="left">
    <h1>مزرعتي — Mini Farm</h1>
    <div class="row status">
      <div class="chip">💰 <span id="coins">0</span> Coins</div>
      <div class="chip">⭐ <span id="xp">0</span> XP</div>
      <div class="chip small">المستوى: <strong id="level">1</strong></div>
    </div>

    <div class="row">
      <div class="small">اختر البذرة للزراعة:</div>
      <select id="seedSelect"></select>
      <button id="plantBtn" class="primary">زرع</button>
      <button id="harvestAllBtn">حصاد الكل</button>
      <button id="storeBtn">المخزن</button>
      <button id="resetBtn" style="margin-left:auto">إعادة ضبط</button>
    </div>

    <div class="grid" id="grid"></div>

    <div class="footer">اضغط على مربع لزرعه أو لحصاد ما إذا كان جاهزًا. اللعبة تحفظ تلقائيًا.</div>

    <!-- Modal Store -->
    <div id="storeModal" class="modal">
      <div class="modal-content">
        <h2>المخزن</h2>
        <div id="storeItems"></div>
        <button onclick="closeStore()">إغلاق</button>
      </div>
    </div>
  </div>

  <div class="right">
    <h1>سجل الأحداث</h1>
    <div id="log" class="log"></div>
  </div>
</div>

<script>
/* ======= Configuration ======= */
const GRID_ROWS = 5;
const GRID_COLS = 5;
const SAVE_KEY = 'mini_farm_v2';
const CROPS = {
  wheat: { name:'قمح', emoji:'🌾', growSeconds: 60, cost:5, yield:10, sellPrice:8, xp:1 },
  tomato:{ name:'طماطم', emoji:'🍅', growSeconds: 120, cost:10, yield:25, sellPrice:20, xp:3 },
  corn:  { name:'ذرة', emoji:'🌽', growSeconds: 300, cost:25, yield:70, sellPrice:60, xp:7 }
};
/* ============================= */

let state = {
  coins: 100,
  xp: 0,
  tiles: [], // each tile: { cropId, plantedAt, readyAt }
  inventory: {}, // cropId -> quantity
  lastSave: Date.now()
};

const gridEl = document.getElementById('grid');
const coinsEl = document.getElementById('coins');
const xpEl = document.getElementById('xp');
const lvlEl = document.getElementById('level');
const seedSelect = document.getElementById('seedSelect');
const logEl = document.getElementById('log');
const plantBtn = document.getElementById('plantBtn');
const harvestAllBtn = document.getElementById('harvestAllBtn');
const resetBtn = document.getElementById('resetBtn');
const storeBtn = document.getElementById('storeBtn');
const storeModal = document.getElementById('storeModal');
const storeItems = document.getElementById('storeItems');

function init(){
  const saved = localStorage.getItem(SAVE_KEY);
  if(saved){
    try { state = JSON.parse(saved); } catch(e){ console.warn('load failed',e); localStorage.removeItem(SAVE_KEY) }
  }
  const totalTiles = GRID_ROWS * GRID_COLS;
  if(!state.tiles || state.tiles.length !== totalTiles){
    state.tiles = Array(totalTiles).fill(null).map(()=>({ cropId:null, plantedAt:0, readyAt:0 }));
  }
  for(const id in CROPS){
    const opt = document.createElement('option');
    opt.value = id;
    opt.textContent = `${CROPS[id].emoji} ${CROPS[id].name} — تكلفة ${CROPS[id].cost}`;
    seedSelect.appendChild(opt);
    if(!state.inventory[id]) state.inventory[id] = 0;
  }
  gridEl.innerHTML = '';
  for(let i=0;i<GRID_ROWS*GRID_COLS;i++){
    const t = document.createElement('div');
    t.className = 'tile';
    t.dataset.index = i;
    t.onclick = ()=> onTileClick(i);
    t.innerHTML = `<div class="info" id="info-${i}"></div><div class="soil" id="soil-${i}">🟫</div><div class="progress" id="prog-${i}"></div>`;
    gridEl.appendChild(t);
  }
  attachButtons();
  refreshUI();
  startTicker();
  log('اللعبة جاهزة — لديك ' + state.coins + ' عملات للبدء');
}

function attachButtons(){
  plantBtn.onclick = () => {
    const idx = state.tiles.findIndex(t=>!t.cropId);
    if(idx === -1){ alert('لا توجد مربعات فارغة.'); return; }
    plantAt(idx);
  };
  harvestAllBtn.onclick = harvestAll;
  resetBtn.onclick = ()=> { if(confirm('هل تريد إعادة ضبط اللعبة؟')) { resetGame(); } };
  storeBtn.onclick = ()=> { renderStore(); storeModal.style.display='flex'; };
}

function plantAt(index){
  const cropId = seedSelect.value;
  const crop = CROPS[cropId];
  if(!crop) return;
  if(state.tiles[index].cropId) { log('المربع مش فارغ!'); return; }
  if(state.coins < crop.cost){ alert('ليس لديك ما يكفي من العملات'); return; }
  const now = Date.now();
  state.coins -= crop.cost;
  state.tiles[index] = { cropId, plantedAt: now, readyAt: now + crop.growSeconds*1000 };
  log(`زرعت ${crop.emoji} ${crop.name} في المربع ${index+1}`);
  save(); refreshUI();
}

function onTileClick(index){
  const tile = state.tiles[index];
  if(!tile || !tile.cropId){ plantAt(index); return; }
  const now = Date.now();
  if(now >= tile.readyAt){ harvestAt(index); } 
  else { const remaining = Math.ceil((tile.readyAt - now)/1000); alert(`لم ينضج بعد ${remaining} ثانية.`); }
}

function harvestAt(index){
  const tile = state.tiles[index];
  if(!tile || !tile.cropId) return;
  const crop = CROPS[tile.cropId];
  state.inventory[crop.cropId] += crop.yield;
  state.xp += crop.xp;
  log(`حصاد: ${crop.emoji} ${crop.name} +${crop.yield} وحدات`);
  state.tiles[index] = { cropId:null, plantedAt:0, readyAt:0 };
  save(); refreshUI();
}

function harvestAll(){
  let did=false;
  for(let i=0;i<state.tiles.length;i++){
    const t=state.tiles[i];
    if(t && t.cropId && Date.now()>=t.readyAt){ harvestAt(i); did=true; }
  }
  if(!did) log('لا محاصيل جاهزة الآن');
}

function computeLevel(xp){
  let lvl=1, need=100, rem=xp;
  while(rem>=need){ rem-=need; lvl++; need=Math.floor(need*1.25); if(lvl>100) break; }
  return lvl;
}

function refreshUI(){
  coinsEl.textContent = state.coins;
  xpEl.textContent = state.xp;
  lvlEl.textContent = computeLevel(state.xp);
  state.tiles.forEach((t,i)=>{
    const soil = document.getElementById('soil-'+i);
    const info = document.getElementById('info-'+i);
    const prog = document.getElementById('prog-'+i);
    const tileEl = soil.parentElement;
    if(!t || !t.cropId){ soil.textContent='🟫'; info.textContent=''; prog.textContent=''; tileEl.classList.remove('ready'); return; }
    const crop = CROPS[t.cropId];
    soil.textContent = crop.emoji;
    const now = Date.now();
    if(now>=t.readyAt){ prog.textContent='جاهز للحصاد'; tileEl.classList.add('ready'); }
    else{ prog.textContent=Math.ceil((t.readyAt-now)/1000)+'s'; tileEl.classList.remove('ready'); }
    info.textContent=crop.name;
  });
}

function startTicker(){
  setInterval(()=>{ refreshUI(); if(Date.now()-state.lastSave>10000) save(); },1000);
}

function save(){ state.lastSave=Date.now(); localStorage.setItem(SAVE_KEY,JSON.stringify(state)); }

function resetGame(){
  state = { coins:100, xp:0, tiles:Array(GRID_ROWS*GRID_COLS).fill(null).map(()=>({ cropId:null, plantedAt:0, readyAt:0 })), inventory:{}, lastSave:Date.now() };
  for(const id in CROPS) state.inventory[id]=0;
  save(); refreshUI(); log('اللعبة أعيدت من البداية');
}

function log(text){
  const p=document.createElement('div');
  p.textContent=`[${new Date().toLocaleTimeString()}] ${text}`;
  logEl.prepend(p);
}

// ======= Store =======
function renderStore(){
  storeItems.innerHTML='';
  for(const id in state.inventory){
    const qty = state.inventory[id];
    if(qty>0){
      const crop = CROPS[id];
      const div = document.createElement('div');
      div.innerHTML=`
        <span>${crop.emoji} ${crop.name}: ${qty}</span>
        <span>
          <input type="number" min="1" max="${qty}" value="1" id="sell-${id}" style="width:50px">
          <button onclick="sellCrop('${id}')">بيع (${crop.sellPrice})</button>
        </span>
      `;
      storeItems.appendChild(div);
    }
  }
}

function sellCrop(cropId){
  const input = document.getElementById(`sell-${cropId}`);
  let qty = parseInt(input.value);
  if(isNaN(qty) || qty<=0) return;
  if(qty>state.inventory[cropId]) qty=state.inventory[cropId];
  const crop = CROPS[cropId];
  const earnings = qty*crop.sellPrice;
  state.coins += earnings;
  state.inventory[cropId] -= qty;
  log(`بعت ${qty} من ${crop.emoji} ${crop.name} مقابل ${earnings} عملة`);
  renderStore();
  refreshUI();
}

function closeStore(){ storeModal.style.display='none'; }

// ======== Run ========
init();
</script>
</body>
</html>
